package Day_6;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;

public class HttpServer {

	private static final String CLOSE_COMMAND = "CLOSE";
	private static final int PORT = 4444;
	
	public static void main(String[] args) throws IOException {

		boolean closing = false;
		// create socket
		try (ServerSocket serverSocket = new ServerSocket(PORT)) {
			System.out.println("Started server on port " + PORT);

			// repeatedly wait for connections, and process
			while (!closing) {

				// a "blocking" call which waits until a connection is requested
				try (Socket clientSocket = serverSocket.accept()) {
					System.out.println("Accepted connection from client: "
							+ clientSocket);

					// open up IO streams
					InputStream inStream = clientSocket.getInputStream();
					OutputStream outStream = clientSocket.getOutputStream();

					try (
							BufferedReader in = new BufferedReader(new InputStreamReader(inStream));
							PrintWriter out = new PrintWriter(outStream, true);
						) {
						// waits for data and reads it in until connection dies
						// readLine() blocks until the server receives a new line
						// from client
						String s;
						String[] operations = null;
						String query = null;
						while ((s = in.readLine()) != null) {
							if (s.equals(CLOSE_COMMAND)) {
								closing = true;
								out.println("good bye!");
								break;
							}
							operations = s.split(" ");
							query = operations[operations.length - 1];
							//System.out.println(operations[0]);
							if(operations[0].equals("GET")){
								htmlTemplate("Hello World!",out);
								out.println("HTTP/1.0 200 OK");
								out.println("Content-Type: text/html");
								out.println("");
								out.println("<html>");
								out.println("<head>");
								out.println("<title> Hello world! </title>");
								out.println("</head>");
								out.println("<body>");
								out.println("<p> Hello world! </p>");
								out.println("</body>");
								out.println("</html>");
							}
							out.println(query);
						}
					}
				}
			}
		}
	}
	
	public static void htmlTemplate(String word,PrintWriter out){
		out.println(
		"HTTP/1.0 200 OK"
		"Content-Type: text/html"
		+"<html>\n"
		+ "	<head>\n"
		+ "		<title>" + word + "</title>\n"
		+ "	</head>\n"
		+ "	<body>\n"
		+ "		<p>" + word + "</p>\n"
		+ "	</body>\n"
		+ "</html>\n"
		);
	}
}